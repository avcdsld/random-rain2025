<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Befunge</title>
    <style>
        @font-face {
            font-family: 'DejaVu Sans Mono';
            src: url('DejaVuSansMono.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'DejaVu Sans Mono';
            src: url('DejaVuSansMono.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            font-family: 'DejaVu Sans Mono';
            font-weight: normal;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <script>
        class BefungeInterpreter {
            constructor(w, h) {
                this.w = w; this.h = h;
                this.p = Array(h).fill().map(() => Array(w).fill(' '));
                this.x = this.y = this.dx = this.dy = this.stepCount = 0;
                this.dx = 1; this.stack = []; this.out = ''; this.run = true;
                this.str = false;
            }
            
            load(src) {
                src.split('\n').forEach((line, y) => {
                    [...line].forEach((c, x) => this.p[y] && (this.p[y][x] = c));
                });
                if (this.h >= 2) {
                    const [a, b] = [0, 1].map(() => Math.floor(Math.random() * this.w));
                    this.p[1] = Array(this.w).fill(' ');
                    this.p[1][a] = this.p[1][b] = '?';
                }
            }
            
            pop() { return this.stack.pop() || 0; }
            
            step() {
                const c = this.p[this.y][this.x];
                if (this.str) {
                    if (c === '"') this.str = false;
                    else this.stack.push(c.charCodeAt(0));
                } else {
                    const ops = {
                        '>': () => [this.dx, this.dy] = [1, 0],
                        '<': () => [this.dx, this.dy] = [-1, 0],
                        '^': () => [this.dx, this.dy] = [0, -1],
                        'v': () => [this.dx, this.dy] = [0, 1],
                        '?': () => { const r = Math.random(); [this.dx, this.dy] = [[1, 0], [-1, 0], [0, 1], [0, -1]][r < 0.3 ? 0 : r < 0.5 ? 1 : r < 0.8 ? 2 : 3]; },
                        '_': () => [this.dx, this.dy] = [this.pop() ? -1 : 1, 0],
                        '|': () => [this.dx, this.dy] = [0, this.pop() ? -1 : 1],
                        '"': () => this.str = true,
                        '+': () => this.stack.push(this.pop() + this.pop()),
                        '-': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(b - a); },
                        '*': () => this.stack.push(this.pop() * this.pop()),
                        '/': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(a ? Math.floor(b/a) : 0); },
                        '%': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(a ? b%a : 0); },
                        '!': () => this.stack.push(this.pop() ? 0 : 1),
                        '`': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(b > a ? 1 : 0); },
                        ':': () => this.stack.push(this.stack[this.stack.length-1] || 0),
                        '\\': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(a, b); },
                        '$': () => this.pop(),
                        '.': () => this.out += this.pop() + ' ',
                        ',': () => this.out += String.fromCharCode(this.pop()),
                        '#': () => this.move(),
                        'g': () => { const [y,x] = [this.pop(), this.pop()]; this.stack.push(this.p[y%this.h][x%this.w].charCodeAt(0)); },
                        'p': () => { const [y,x,v] = [this.pop(), this.pop(), this.pop()]; this.p[y%this.h][x%this.w] = String.fromCharCode(v%256); },
                        '&': () => this.stack.push(0),
                        '~': () => this.stack.push(0),
                        '@': () => this.run = false
                    };
                    if (/\d/.test(c)) this.stack.push(+c);
                    else if (ops[c]) ops[c]();
                }
                this.move();
                this.stepCount++;
                return this.run;
            }
            
            move() {
                this.x = (this.x + this.dx) % this.w;
                this.y = (this.y + this.dy) % this.h;
                if (this.x < 0) this.x += this.w;
                if (this.y < 0) this.y += this.h;
            }
        }

        class BefungeRenderer {
            constructor(id, w, h) {
                this.c = document.getElementById(id).getContext('2d');
                this.w = w; this.h = h;
            }
            
            render(s, p) {
                const scale = Math.max(0.3, Math.min(window.innerWidth / (this.w*7+60), window.innerHeight / ((this.h+2)*18+60)));
                const cw = 7*scale, ch = 18*scale, m = 30*scale;
                
                this.c.canvas.width = this.w*cw + m*2;
                this.c.canvas.height = (this.h+2)*ch + m*2;
                this.c.font = `${12*scale}px 'DejaVu Sans Mono', monospace`;
                this.c.textBaseline = 'middle';
                this.c.textAlign = 'center';
                
                this.c.fillStyle = '#000';
                this.c.fillRect(0, 0, this.c.canvas.width, this.c.canvas.height);
                
                this.c.fillStyle = '#fff';
                this.c.textAlign = 'left';
                this.c.font = `${12*scale}px 'DejaVu Sans Mono', monospace`;
                this.c.fillText(`–– Step ${s.stepCount.toString().padStart(5)} ––`, m, m + ch/2);
                
                this.c.textAlign = 'center';
                this.c.font = `${12*scale}px 'DejaVu Sans Mono', monospace`;
                for (let y = 0; y < this.h; y++) {
                    for (let x = 0; x < this.w; x++) {
                        const c = p[y][x];
                        const cx = m + (x + 0.5) * cw;
                        const cy = m + (y + 1.5) * ch;
                        
                        if (x === s.x && y === s.y) {
                            this.c.fillStyle = '#fff';
                            this.c.fillRect(m + x*cw, m + (y+1)*ch, cw, ch);
                            this.c.fillStyle = '#000';
                            if (c !== ' ') this.c.fillText(c, cx, cy);
                        } else {
                            this.c.fillStyle = '#fff';
                            if (c !== ' ') this.c.fillText(c, cx, cy);
                        }
                    }
                }
                
                this.c.fillStyle = '#fff';
                this.c.textAlign = 'left';
                const sy = m + (this.h + 1.5) * ch;
                const cmd = p[s.y][s.x];
                const status = `IP:(${s.x.toString().padStart(2)}, ${s.y.toString().padStart(2)}) Dir:(${s.dx>=0?'+':''}${s.dx},${s.dy>=0?'+':''}${s.dy}) Cmd:'${cmd}'`;
                this.c.fillText(status, m, sy);
                if (s.outputBuffer) {
                    this.c.fillText(` Output: ${s.outputBuffer}`, m + this.c.measureText(status).width, sy);
                }
            }
        }

        const WIDTH = 80;
        const HEIGHT = 25;
        
        const sourceCode = `v                                                                              
                                                   ?                ?           
                     ?    ?                                                     
                                       ?              ?                         
      ?                                                         ?               
      ?                                                        ?                
                  ?                                   ?                         
                                               ?   ?                            
                                 ?                                    ?         
                                  ?    ?                                        
             ?                 ?                                                
                  ?          ?                                                  
                    ?       ?                                                   
     ?                                                  ?                       
                  ?                                       ?                     
        ?                                                            ?          
                                                        ?                      ?
                         ?                                        ?             
    ?                                              ?                            
        ?    ?                                                                  
 ?                                              ?                               
                                           ?                 ?                  
                                   >>>>>>>>>>v<                                 
vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv"Rain."<vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
????????????????????????????????????<>,#$:_@ >??????????????????????????????????`;
        
        const b = new BefungeInterpreter(WIDTH, HEIGHT);
        const r = new BefungeRenderer('canvas', WIDTH, HEIGHT);
        
        b.load(sourceCode);
        
        function resize() {
            r.render({x:b.x,y:b.y,dx:b.dx,dy:b.dy,stepCount:b.stepCount,outputBuffer:b.out,running:b.run}, b.p);
        }
        
        async function run() {
            while (b.step()) {
                r.render({x:b.x,y:b.y,dx:b.dx,dy:b.dy,stepCount:b.stepCount,outputBuffer:b.out,running:b.run}, b.p);
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }
        
        window.addEventListener('resize', resize);
        run();
    </script>
</body>
</html>