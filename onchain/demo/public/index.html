<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Befunge</title>
    <style>
        @font-face {
            font-family: 'DejaVu Sans Mono';
            src: url('DejaVuSansMono.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'DejaVu Sans Mono';
            src: url('DejaVuSansMono.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        pre {
            display: block;
            font-family: 'DejaVu Sans Mono', monospace;
            font-weight: normal;
            font-size: 12px;
            color: #fff;
            background: #000;
            margin: 0;
            padding: 3px 12px 8px 12px;
            white-space: pre;
            overflow: auto;
            max-width: 100vw;
            max-height: 100vh;
            line-height: 1.2;
            box-sizing: border-box;
        }
        .ip-highlight {
            background: #fff;
            color: #000;
        }
    </style>
</head>
<body>
    <pre id="canvas"></pre>
    
    <script>
        class BefungeInterpreter {
            constructor(w, h) {
                this.w = w; this.h = h;
                this.p = Array(h).fill().map(() => Array(w).fill(' '));
                this.x = this.y = this.dx = this.dy = this.stepCount = 0;
                this.dx = 1; this.stack = []; this.out = ''; this.run = true;
                this.str = false;
            }
            
            load(src) {
                src.split('\n').forEach((line, y) => {
                    [...line].forEach((c, x) => this.p[y] && (this.p[y][x] = c));
                });
                if (this.h >= 2) {
                    const [a, b] = [0, 1].map(() => Math.floor(Math.random() * this.w));
                    this.p[1] = Array(this.w).fill(' ');
                    this.p[1][a] = this.p[1][b] = '?';
                }
            }
            
            pop() { return this.stack.pop() || 0; }
            
            step() {
                const c = this.p[this.y][this.x];
                if (this.str) {
                    if (c === '"') this.str = false;
                    else this.stack.push(c.charCodeAt(0));
                } else {
                    const ops = {
                        '>': () => [this.dx, this.dy] = [1, 0],
                        '<': () => [this.dx, this.dy] = [-1, 0],
                        '^': () => [this.dx, this.dy] = [0, -1],
                        'v': () => [this.dx, this.dy] = [0, 1],
                        '?': () => { const r = Math.random(); [this.dx, this.dy] = [[1, 0], [-1, 0], [0, 1], [0, -1]][r < 0.3 ? 0 : r < 0.5 ? 1 : r < 0.8 ? 2 : 3]; },
                        '_': () => [this.dx, this.dy] = [this.pop() ? -1 : 1, 0],
                        '|': () => [this.dx, this.dy] = [0, this.pop() ? -1 : 1],
                        '"': () => this.str = true,
                        '+': () => this.stack.push(this.pop() + this.pop()),
                        '-': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(b - a); },
                        '*': () => this.stack.push(this.pop() * this.pop()),
                        '/': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(a ? Math.floor(b/a) : 0); },
                        '%': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(a ? b%a : 0); },
                        '!': () => this.stack.push(this.pop() ? 0 : 1),
                        '`': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(b > a ? 1 : 0); },
                        ':': () => this.stack.push(this.stack[this.stack.length-1] || 0),
                        '\\': () => { const [a,b] = [this.pop(), this.pop()]; this.stack.push(a, b); },
                        '$': () => this.pop(),
                        '.': () => this.out += this.pop() + ' ',
                        ',': () => this.out += String.fromCharCode(this.pop()),
                        '#': () => this.move(),
                        'g': () => { const [y,x] = [this.pop(), this.pop()]; this.stack.push(this.p[y%this.h][x%this.w].charCodeAt(0)); },
                        'p': () => { const [y,x,v] = [this.pop(), this.pop(), this.pop()]; this.p[y%this.h][x%this.w] = String.fromCharCode(v%256); },
                        '&': () => this.stack.push(0),
                        '~': () => this.stack.push(0),
                        '@': () => this.run = false
                    };
                    if (/\d/.test(c)) this.stack.push(+c);
                    else if (ops[c]) ops[c]();
                }
                this.move();
                this.stepCount++;
                return this.run;
            }
            
            move() {
                this.x = (this.x + this.dx) % this.w;
                this.y = (this.y + this.dy) % this.h;
                if (this.x < 0) this.x += this.w;
                if (this.y < 0) this.y += this.h;
            }
        }

        class BefungeRenderer {
            constructor(id, w, h) {
                this.elem = document.getElementById(id);
                this.w = w; this.h = h;
                this.updateFontSize();
            }
            
            updateFontSize() {
                const baseFontSize = 12;
                const charWidth = baseFontSize * 0.6;
                const lineHeightRatio = 1.2;
                const baseLineHeight = baseFontSize * lineHeightRatio;
                
                const paddingX = 24;
                const paddingTop = 10;
                const paddingBottom = 10;
                const paddingY = paddingTop + paddingBottom;

                const totalLines = this.h + 3;
                
                const scaleX = (window.innerWidth - paddingX) / (this.w * charWidth);
                const scaleY = (window.innerHeight - paddingY) / (totalLines * baseLineHeight);
                const scale = Math.max(0.5, Math.min(scaleX, scaleY));
                
                const fontSize = Math.floor(baseFontSize * scale);
                this.elem.style.fontSize = `${fontSize}px`;
            }
            
            render(s, p) {
                let output = '';
                
                output += `–– Step ${s.stepCount.toString()} ––\n`;
                
                for (let y = 0; y < this.h; y++) {
                    for (let x = 0; x < this.w; x++) {
                        const c = p[y][x];
                        if (x === s.x && y === s.y) {
                            output += `<span class="ip-highlight">${c === ' ' ? '&nbsp;' : this.escapeHtml(c)}</span>`;
                        } else {
                            output += c === ' ' ? '&nbsp;' : this.escapeHtml(c);
                        }
                    }
                    output += '\n';
                }

                const cmd = p[s.y][s.x];
                const status = `IP:(${s.x.toString().padStart(2)}, ${s.y.toString().padStart(2)}) Dir:(${s.dx>=0?'+':''}${s.dx},${s.dy>=0?'+':''}${s.dy}) Cmd:'${this.escapeHtml(cmd)}'`;
                output += status;

                output += '\n';
                if (s.outputBuffer) {
                    output += this.escapeHtml(s.outputBuffer);
                } else {
                    output += ' ';
                }
                
                this.elem.innerHTML = output;
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        const WIDTH = 80;
        const HEIGHT = 25;
        
        const sourceCode = `vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
                                                   ?                ?           
                     ?    ?                                                     
                                       ?              ?                         
      ?                                                         ?               
      ?                                                        ?                
                  ?                                   ?                         
                                               ?   ?                            
                                 ?                                    ?         
                                  ?    ?                                        
             ?                 ?                                               
                  ?          ?               ?                                  
                    ?       ?                                                   
     ?                                                  ?                       
                  ?                                       ?                     
        ?                                                            ?          
                                                        ?                      ?
                         ?                                        ?             
    ?                                              ?                            
        ?    ?                                                                  
 ?                                              ?                               
                                           ?                 ?                  
                                   >>>>>>>>>>v<                                 
vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv"Rain."<vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
????????????????????????????????????<>,#$:_@ >??????????????????????????????????`;
        
        const b = new BefungeInterpreter(WIDTH, HEIGHT);
        const r = new BefungeRenderer('canvas', WIDTH, HEIGHT);
        
        b.load(sourceCode);
        
        function resize() {
            r.updateFontSize();
            r.render({x:b.x,y:b.y,dx:b.dx,dy:b.dy,stepCount:b.stepCount,outputBuffer:b.out,running:b.run}, b.p);
        }
        
        async function run() {
            while (b.step()) {
                r.render({x:b.x,y:b.y,dx:b.dx,dy:b.dy,stepCount:b.stepCount,outputBuffer:b.out,running:b.run}, b.p);
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }
        
        window.addEventListener('resize', resize);
        run();
    </script>
</body>
</html>